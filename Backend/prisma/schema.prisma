generator client{
  provider = "prisma-client-js"
}

datasource db{
  provider = "postgresql"
  url = env("DATABASE_URL")
}

model User{
  id Int @id @default(autoincrement())
  email String @unique
  password String?
  firstName String
  lastName String
  role Role @default(USER)
  isActive Boolean @default(true)
  emailVerified Boolean @default(false)
  googleId String? @unique
  avatar String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshTokens RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  projects Project[]
  comments Comment[]

  @@map("users")
}

model RefreshToken{
  id Int @id @default(autoincrement())
  token String @unique
  userId Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetToken{
  id Int @id @default(autoincrement())
  token String @unique
  userId Int
  expiresAt DateTime
  used Boolean @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  newEmail  String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

model Project {
  id Int @id @default(autoincrement())
  userId Int
  name String
  description String?
  repoUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  files File[]

  @@index([userId])
  @@map("projects")
}

model File {
  id Int @id @default(autoincrement())
  projectId Int
  filename String
  path String
  content String @db.Text
  language String
  size Int
  lastModified DateTime
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviews Review[]

  @@index([projectId])
  @@map("files")
}

model Review {
  id Int @id @default(autoincrement())
  fileId Int
  modelUsed String
  status ReviewStatus @default(COMPLETED)
  report Json @db.JsonB
  summary Json? @db.JsonB
  metadata Json? @db.JsonB
  createdAt DateTime @default(now())

  file File @relation(fields: [fileId], references: [id], onDelete: Cascade)
  comments Comment[]

  @@index([fileId])
  @@index([createdAt])
  @@map("reviews")
}

model Comment {
  id Int @id @default(autoincrement())
  reviewId Int
  authorId Int
  lineNumber Int?
  commentText String @db.Text
  isAI Boolean @default(false)
  createdAt DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@map("comments")
}

enum ReviewStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum Role {
  USER
  ADMIN
}